# HTTPS redirect for www.storydot.kr and storydot.kr
server {
    listen 443 ssl http2;
    server_name www.storydot.kr storydot.kr;

    # SSL certificates (same as trendy.storydot.kr)
    ssl_certificate /etc/letsencrypt/live/trendy.storydot.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/trendy.storydot.kr/privkey.pem;

    # Redirect to trendy.storydot.kr
    return 301 https://trendy.storydot.kr$request_uri;
}

# HTTP to HTTPS redirect for all domains
server {
    listen 80;
    server_name storydot.kr www.storydot.kr trendy.storydot.kr;
    return 301 https://trendy.storydot.kr$request_uri;
}

# Main HTTPS server for trendy.storydot.kr
server {
    listen 443 ssl http2;
    server_name trendy.storydot.kr;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    root /mnt/storage/wordpress;

    # ====== LAW (SAFECONTRACT) SECTION ======
    location ^~ /law/api/ {
        proxy_pass http://localhost:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /law/assets/ {
        alias /mnt/storage/law/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /law/ {
        alias /mnt/storage/law/dist/;
        try_files $uri $uri/ /law/index.html;
    }

    location = /law {
        return 301 /law/;
    }

    # ====== NPL STO PLATFORM SECTION ======
    location ^~ /nplsto/assets/ {
        alias /mnt/storage/nplsto/dist/public/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /nplsto/api/ {
        proxy_pass http://localhost:5007/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /nplsto/ {
        alias /mnt/storage/nplsto/dist/public/;
        try_files $uri $uri/ /nplsto/index.html;
        index index.html;
    }

    location = /nplsto {
        return 301 /nplsto/;
    }

    # ====== STABLE SECTION ======
    location ^~ /stable/api/ {
        proxy_pass http://localhost:5008/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /stable/assets/ {
        alias /mnt/storage/stable/dist/public/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /stable/ {
        alias /mnt/storage/stable/dist/public/;
        try_files $uri $uri/ /stable/index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    location = /stable {
        return 301 /stable/;
    }

    # ====== XIMAGE NFT MARKETPLACE SECTION ======
    location ^~ /ximage/api/ws/ {
        proxy_pass http://localhost:5004/api/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    location ^~ /ximage/api/ {
        proxy_pass http://localhost:5004/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location ^~ /ximage/assets/ {
        alias /mnt/storage/ximage/dist/public/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
        try_files $uri =404;

        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    location ^~ /ximage/ {
        alias /mnt/storage/ximage/dist/public/;
        try_files $uri $uri/ /ximage/index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    location = /ximage {
        return 301 /ximage/;
    }

    # ====== XPSWAP DEX SECTION ======
    location ^~ /xpswap/launchpad/api/ {
        proxy_pass http://localhost:5006/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /xpswap/api/ws/ {
        proxy_pass http://localhost:5101;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    location ^~ /xpswap/api/ {
        proxy_pass http://localhost:5000/xpswap/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location ^~ /xpswap/assets/ {
        alias /mnt/storage/xpswap/dist/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
        try_files $uri =404;

        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    location ^~ /xpswap/ {
        alias /mnt/storage/xpswap/dist/;
        try_files $uri $uri/ /xpswap/index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    location = /xpswap {
        return 301 /xpswap/;
    }

    # ====== SUPERWALLET LANDING PAGE SECTION ======
    location ^~ /superwallet-landing/assets/ {
        alias /mnt/storage/superwallet/dist/landing/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /superwallet-landing/ {
        alias /mnt/storage/superwallet/dist/landing/;
        try_files $uri $uri/ /superwallet-landing/index.html;
        index index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    location = /superwallet-landing {
        return 301 /superwallet-landing/;
    }

    location ^~ /superwallet/ {
        alias /mnt/storage/superwallet/;
        try_files $uri $uri/ /superwallet/index.html;
    }

    # ====== SUPERWALLET DID SECTION ======
    location ^~ /superwallet-did/ {
        alias /mnt/storage/superwallet_did/;
        index index.html monitor.html superwallet-did-api-docs.html;
        try_files $uri $uri/ =404;
    }

    location = /superwallet-did {
        return 301 /superwallet-did/;
    }

    # ====== SUPERWALLET API SECTION ======
    location ^~ /superwallet-api/ {
        rewrite ^/superwallet-api/(.*) /api/$1 break;
        proxy_pass http://localhost:8090;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ====== SIGNCHAIN SECTION ======
    location ^~ /signchain/api/ {
        proxy_pass http://localhost:5015/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location ^~ /signchain/ {
        alias /mnt/storage/signchain/client/;
        try_files $uri $uri/ /signchain/index.html;
    }

    # ====== TRADING BOT AI SECTION ======
    location ^~ /_next/ {
        proxy_pass http://localhost:3001/trading/_next/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /api/v1/ {
        proxy_pass http://localhost:3001/trading/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    location ^~ /trading/_next/ {
        proxy_pass http://localhost:3001/trading/_next/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /trading/api/auth/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    location ^~ /trading/api/v1/ {
        rewrite ^/trading/api/v1/(.*) /api/v1/$1 break;
        proxy_pass http://localhost:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
        proxy_pass_header Authorization;
        proxy_set_header Authorization $http_authorization;
    }

    location ^~ /trading/api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    location = /trading {
        proxy_pass http://localhost:3001/trading;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    location ^~ /trading/ {
        proxy_pass http://localhost:3001/trading/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # ====== HELIOS WALLET SECTION ======
    location = /wallet {
        return 301 /wallet/;
    }

    location ^~ /wallet/ {
        alias /mnt/storage/wallet/dist/;
        index index.html;
        try_files $uri $uri/ /wallet/index.html;
    }

    # ====== MAINNET SECTION ======
    location ^~ /mainnet/ {
        alias /mnt/storage/mainnet/;
        try_files $uri $uri/ /mainnet/index.html;
        index index.html;
    }

    location = /mainnet {
        return 301 /mainnet/;
    }

    # ====== AI BUILDER HOUSE LANDING ======
    location ^~ /landing {
        alias /mnt/storage/landing/;
        index index.html;
    }

    # ====== SYSTEM MONITORING DASHBOARD ======
    location ^~ /service/ {
        alias /mnt/storage/monitoring-dashboard/;
        try_files $uri $uri/ /service/index.html;
        index index.html;
    }

    location ~ ^/service/.*\.md$ {
        alias /mnt/storage/monitoring-dashboard/;
        types {
            text/plain md;
        }
        default_type text/plain;
    }

    location = /service {
        return 301 /service/;
    }

    # ====== API DOCUMENTATION ======
    location ^~ /api-docs/ {
        alias /mnt/storage/api-documentation/;
        try_files $uri $uri/ /api-docs/index.html;
        index index.html;
    }

    location = /api-docs {
        return 301 /api-docs/;
    }

    # ====== TELEGRAM BOT SECTION ======
    location ^~ /telegram_bot/ {
        alias /mnt/storage/wordpress/telegram_bot/;
        index seoul_labs_telegram_bot.php;

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
    }

    # ====== DID-BAAS SECTION ======
    location ^~ /did-baas/api/ {
        rewrite ^/did-baas/api/(.*) /api/$1 break;
        proxy_pass http://localhost:8091;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "https://trendy.storydot.kr" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key" always;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /did-baas/assets/ {
        alias /mnt/storage/did_baas/baas-dashboard/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /did-baas/ {
        alias /mnt/storage/did_baas/baas-dashboard/dist/;
        try_files $uri $uri/ /did-baas/index.html;
        index index.html;
    }

    location = /did-baas {
        return 301 /did-baas/;
    }

    # ====== MEDIGUARD HEALTH SECTION ======
    location ^~ /health/api/ {
        proxy_pass http://localhost:8098/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /health/assets/ {
        alias /mnt/storage/health/dist/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /health/ {
        alias /mnt/storage/health/dist/;
        try_files $uri $uri/ /health/index.html;
        index index.html;
    }

    location = /health {
        return 301 /health/;
    }

    # ====== XPHERE HEALTH-WEB3 SECTION ======
    location ^~ /health-web3/assets/ {
        alias /mnt/storage/health-web3/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /health-web3/ {
        alias /mnt/storage/health-web3/;
        try_files $uri $uri/ /health-web3/index.html;
        index index.html;
    }

    location = /health-web3 {
        return 301 /health-web3/;
    }

    # ====== BRIDGE API SECTION ======
    location ^~ /bridge-api/ {
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_pass http://127.0.0.1:3011/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    # ====== INDEXER API SECTION ======
    location ^~ /indexer-api/ {
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_pass http://127.0.0.1:3010/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    # ====== WEB3 EXPLORER SECTION ======
    location ^~ /explorer/assets/ {
        alias /mnt/storage/explorer/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /explorer/ {
        alias /mnt/storage/explorer/;
        try_files $uri $uri/ /explorer/index.html;
        index index.html;
    }

    location = /explorer {
        return 301 /explorer/;
    }

    # ====== REALCARE AI SECTION ======
    location ^~ /real/assets/ {
        alias /mnt/storage/real/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /real/ {
        alias /mnt/storage/real/dist/;
        try_files $uri $uri/ /real/index.html;
        index index.html;
    }

    location = /real {
        return 301 /real/;
    }

    # ====== LOCALPAY APP SECTION ======
    location ^~ /localpay/api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /localpay/ {
        alias /mnt/storage/localpay/dist/;
        index index.html;
        try_files $uri $uri/ /localpay/index.html;
    }

    location = /localpay {
        return 301 /localpay/;
    }

    # ====== TUBEGENIUS AI (YOUTUBE) SECTION ======
    location ^~ /youtube/_next/static/ {
        alias /mnt/storage/youtube/apps/web/.next/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /youtube {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ====== XPHERE CLOUD MINING SECTION ======
    # Cloud Mining API - Port 4100
    location ^~ /cloudmining/api/ {
        rewrite ^/cloudmining/api/(.*) /$1 break;
        proxy_pass http://127.0.0.1:4100;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Cloud Mining Assets
    location ^~ /cloudmining/assets/ {
        alias /mnt/storage/cloudmining/frontend/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Cloud Mining Frontend SPA
    location ^~ /cloudmining/ {
        alias /mnt/storage/cloudmining/frontend/dist/;
        try_files $uri $uri/ /cloudmining/index.html;
        index index.html;
    }

    location = /cloudmining {
        return 301 /cloudmining/;
    }

    # ====== WORDPRESS (DEFAULT) - LAST PRIORITY ======
    location / {
        root /mnt/storage/wordpress;
        index index.php index.html index.htm;
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP handling for WordPress
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_connect_timeout 300s;
        fastcgi_buffer_size 256k;
        fastcgi_buffers 32 256k;
        fastcgi_busy_buffers_size 512k;
        fastcgi_temp_file_write_size 512k;
    }

    # WordPress uploads security
    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
    }

    # WordPress config security
    location ~* /(wp-config\.php|xmlrpc\.php) {
        deny all;
    }

    # Static file caching
    location ~* ^(?!/xpswap/|/superwallet/|/signchain/|/stable/|/ximage/|/meme/).*\.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # Deny hidden files
    location ~ /\. {
        deny all;
    }
}
